/*
 * Copyright 2025 Contrast Security
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.contrast.labs.ai.mcp.contrast.mapper;

import com.contrast.labs.ai.mcp.contrast.FilterHelper;
import com.contrast.labs.ai.mcp.contrast.data.VulnLight;
import com.contrast.labs.ai.mcp.contrast.data.Vulnerability;
import com.contrast.labs.ai.mcp.contrast.hints.HintGenerator;
import com.contrastsecurity.models.Trace;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Optional;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.util.CollectionUtils;
import org.springframework.util.StringUtils;

/**
 * Centralized mapper for transforming Contrast SDK Trace objects into MCP vulnerability
 * representations. Eliminates code duplication across multiple service methods by providing
 * consistent transformation logic.
 */
@Component
@Slf4j
public class VulnerabilityMapper {
  /**
   * Transform a Trace object into a lightweight vulnerability representation. Used for list
   * endpoints where full details aren't needed. Session metadata is populated when
   * expand=session_metadata is used in the SDK call. Application data is populated when
   * expand=application is used in the SDK call.
   *
   * @param trace The trace object from Contrast SDK
   * @return VulnLight object with essential vulnerability information
   */
  public VulnLight toVulnLight(Trace trace) {
    // Extract application info safely, handling null cases
    String appId = null;
    String appName = null;
    if (trace.getApplication() != null) {
      appId = trace.getApplication().getId();
      appName = trace.getApplication().getName();
    }

    return new VulnLight(
        trace.getTitle(),
        trace.getRule(),
        trace.getUuid(),
        trace.getSeverity(),
        appId,
        appName,
        Optional.ofNullable(trace.getSessionMetadata()).orElse(Collections.emptyList()),
        FilterHelper.formatTimestamp(trace.getLastTimeSeen()),
        trace.getStatus(),
        FilterHelper.formatTimestamp(trace.getFirstTimeSeen()),
        FilterHelper.formatTimestamp(trace.getClosedTime()),
        extractEnvironments(trace),
        extractTags(trace));
  }

  /**
   * Transform a Trace object with additional context into a full vulnerability representation. Used
   * for detail endpoints where comprehensive information is needed.
   *
   * @param trace The trace object from Contrast SDK
   * @param context Additional context data (recommendation, stack libs, http request)
   * @return Vulnerability object with complete vulnerability information
   */
  public Vulnerability toFullVulnerability(Trace trace, VulnerabilityContext context) {
    var hint = HintGenerator.generateVulnerabilityFixHint(trace.getRule());

    // Extract application info safely, handling null cases
    String appId = null;
    String appName = null;
    if (trace.getApplication() != null) {
      appId = trace.getApplication().getId();
      appName = trace.getApplication().getName();
    }

    return new Vulnerability(
        hint,
        trace.getUuid(),
        trace.getTitle(),
        trace.getRule(),
        trace.getSeverity(),
        appId,
        appName,
        context.recommendation(),
        context.stackLibs(),
        context.libraries(),
        context.httpRequest(),
        trace.getStatus(),
        FilterHelper.formatTimestamp(trace.getFirstTimeSeen()),
        FilterHelper.formatTimestamp(trace.getLastTimeSeen()),
        FilterHelper.formatTimestamp(trace.getClosedTime()),
        extractEnvironments(trace),
        extractTags(trace),
        Optional.ofNullable(trace.getSessionMetadata()).orElse(Collections.emptyList()));
  }

  /**
   * Extract unique environments from trace server_environments field. Returns all environments the
   * vulnerability has been seen in over time. Uses the lightweight server_environments field
   * instead of full server objects.
   *
   * @param trace The trace object containing server environment information
   * @return List of unique environment names (e.g., ["DEVELOPMENT", "PRODUCTION", "QA"])
   */
  private List<String> extractEnvironments(Trace trace) {
    var serverEnvironments = trace.getServerEnvironments();
    log.debug(
        "Trace {} getServerEnvironments() returned: {}",
        trace.getUuid(),
        serverEnvironments == null ? "null" : serverEnvironments);

    if (CollectionUtils.isEmpty(serverEnvironments)) {
      return new ArrayList<>();
    }
    return serverEnvironments.stream().filter(StringUtils::hasText).distinct().sorted().toList();
  }

  /**
   * Extract tags from trace. Returns all tags associated with the vulnerability.
   *
   * @param trace The trace object containing tag information
   * @return List of tags (e.g., ["SmartFix Remediated", "reviewed"])
   */
  private List<String> extractTags(Trace trace) {
    if (trace.getTags() == null || trace.getTags().isEmpty()) {
      return new ArrayList<>();
    }
    return new ArrayList<>(trace.getTags());
  }
}
