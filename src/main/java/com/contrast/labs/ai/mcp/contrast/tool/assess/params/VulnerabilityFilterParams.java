/*
 * Copyright 2025 Contrast Security
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.contrast.labs.ai.mcp.contrast.tool.assess.params;

import com.contrast.labs.ai.mcp.contrast.sdkextension.ExtendedTraceFilterBody;
import com.contrast.labs.ai.mcp.contrast.tool.base.BaseToolParams;
import com.contrast.labs.ai.mcp.contrast.tool.validation.ToolValidationContext;
import com.contrast.labs.ai.mcp.contrast.tool.validation.ValidationConstants;
import com.contrastsecurity.http.RuleSeverity;
import com.contrastsecurity.http.ServerEnvironment;
import java.util.Date;
import java.util.EnumSet;
import java.util.HashSet;
import java.util.List;

/**
 * Vulnerability filter parameters using fluent validation API. Demonstrates the
 * ToolValidationContext pattern for tool-per-class architecture.
 *
 * <p>Usage:
 *
 * <pre>{@code
 * var params = VulnerabilityFilterParams.of(
 *     "CRITICAL,HIGH", null, null, "PRODUCTION", null, null, null);
 * if (!params.isValid()) {
 *   // Handle errors
 * }
 * var filterBody = params.toTraceFilterBody();
 * }</pre>
 */
public class VulnerabilityFilterParams extends BaseToolParams {

  private EnumSet<RuleSeverity> severities;
  private List<String> statuses;
  private List<String> vulnTypes;
  private EnumSet<ServerEnvironment> environments;
  private Date lastSeenAfter;
  private Date lastSeenBefore;
  private List<String> vulnTags;

  /** Private constructor - use static factory method {@link #of}. */
  private VulnerabilityFilterParams() {}

  /**
   * Parse and validate vulnerability filter parameters using fluent API.
   *
   * @param severitiesParam Comma-separated severities (CRITICAL,HIGH,MEDIUM,LOW,NOTE)
   * @param statusesParam Comma-separated statuses
   *     (Reported,Suspicious,Confirmed,NotAProblem,Remediated,Fixed,AutoRemediated)
   * @param vulnTypesParam Comma-separated vulnerability types
   * @param environmentsParam Comma-separated environments (DEVELOPMENT,QA,PRODUCTION)
   * @param lastSeenAfterParam ISO date (YYYY-MM-DD) or epoch timestamp
   * @param lastSeenBeforeParam ISO date (YYYY-MM-DD) or epoch timestamp
   * @param vulnTagsParam Comma-separated vulnerability tags
   * @return VulnerabilityFilterParams with validation state
   */
  public static VulnerabilityFilterParams of(
      String severitiesParam,
      String statusesParam,
      String vulnTypesParam,
      String environmentsParam,
      String lastSeenAfterParam,
      String lastSeenBeforeParam,
      String vulnTagsParam) {

    var params = new VulnerabilityFilterParams();
    var ctx = new ToolValidationContext();

    // Parse with fluent API - validation state collected in ctx
    params.severities = ctx.enumSetParam(severitiesParam, RuleSeverity.class, "severities").get();

    params.statuses =
        ctx.stringListParam(statusesParam, "statuses")
            .allowedValues(ValidationConstants.VALID_VULN_STATUSES)
            .defaultTo(
                ValidationConstants.DEFAULT_VULN_STATUSES,
                "Showing actionable vulnerabilities only (excluding Fixed and Remediated). "
                    + "To see all statuses, specify statuses parameter explicitly.")
            .get();

    params.vulnTypes = ctx.stringListParam(vulnTypesParam, "vulnTypes").get();

    params.environments =
        ctx.enumSetParam(environmentsParam, ServerEnvironment.class, "environments").get();

    params.lastSeenAfter = ctx.dateParam(lastSeenAfterParam, "lastSeenAfter").get();
    params.lastSeenBefore = ctx.dateParam(lastSeenBeforeParam, "lastSeenBefore").get();
    ctx.validateDateRange(
        params.lastSeenAfter, params.lastSeenBefore, "lastSeenAfter", "lastSeenBefore");

    // Add time filter note if dates were specified
    if (params.lastSeenAfter != null || params.lastSeenBefore != null) {
      ctx.warnIf(
          true, "Time filters apply to LAST ACTIVITY DATE (lastTimeSeen), not discovery date.");
    }

    params.vulnTags = ctx.stringListParam(vulnTagsParam, "vulnTags").get();

    params.setValidationResult(ctx);
    return params;
  }

  /**
   * Convert to ExtendedTraceFilterBody for POST endpoint API calls.
   *
   * <p>TraceFilterBody has primitive boolean tracked/untracked fields that default to false. When
   * both are false, the API returns ALL vulnerabilities (both tracked and untracked). This avoids
   * the TraceFilterForm default of tracked=true which filters out untracked vulns.
   *
   * @return ExtendedTraceFilterBody configured with all filters including status
   */
  public ExtendedTraceFilterBody toTraceFilterBody() {
    var body = new ExtendedTraceFilterBody();
    // Note: tracked/untracked NOT set - primitive defaults (false, false) mean "return all"
    if (severities != null) {
      body.setSeverities(severities.stream().toList());
    }
    if (statuses != null) {
      body.setStatus(new HashSet<>(statuses));
    }
    if (vulnTypes != null) {
      body.setVulnTypes(vulnTypes);
    }
    if (environments != null) {
      body.setEnvironments(environments.stream().toList());
    }
    if (lastSeenAfter != null) {
      body.setStartDate(lastSeenAfter);
    }
    if (lastSeenBefore != null) {
      body.setEndDate(lastSeenBefore);
    }
    if (vulnTags != null) {
      body.setFilterTags(vulnTags);
    }
    return body;
  }

  public EnumSet<RuleSeverity> getSeverities() {
    return severities;
  }

  public List<String> getStatuses() {
    return statuses;
  }

  public List<String> getVulnTypes() {
    return vulnTypes;
  }

  public EnumSet<ServerEnvironment> getEnvironments() {
    return environments;
  }

  public Date getLastSeenAfter() {
    return lastSeenAfter;
  }

  public Date getLastSeenBefore() {
    return lastSeenBefore;
  }

  public List<String> getVulnTags() {
    return vulnTags;
  }
}
