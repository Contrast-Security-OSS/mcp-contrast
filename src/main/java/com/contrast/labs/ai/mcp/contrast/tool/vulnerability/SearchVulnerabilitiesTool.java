/*
 * Copyright 2025 Contrast Security
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.contrast.labs.ai.mcp.contrast.tool.vulnerability;

import com.contrast.labs.ai.mcp.contrast.PaginationParams;
import com.contrast.labs.ai.mcp.contrast.data.VulnLight;
import com.contrast.labs.ai.mcp.contrast.mapper.VulnerabilityMapper;
import com.contrast.labs.ai.mcp.contrast.sdkextension.SDKExtension;
import com.contrast.labs.ai.mcp.contrast.tool.base.ExecutionResult;
import com.contrast.labs.ai.mcp.contrast.tool.base.PaginatedTool;
import com.contrast.labs.ai.mcp.contrast.tool.base.PaginatedToolResponse;
import com.contrast.labs.ai.mcp.contrast.tool.vulnerability.params.VulnerabilityFilterParams;
import com.contrastsecurity.http.TraceFilterForm.TraceExpandValue;
import java.util.EnumSet;
import java.util.List;
import lombok.RequiredArgsConstructor;
import org.springframework.ai.tool.annotation.Tool;
import org.springframework.ai.tool.annotation.ToolParam;
import org.springframework.stereotype.Service;

/**
 * MCP tool for searching vulnerabilities across all applications in an organization. Demonstrates
 * the tool-per-class pattern with PaginatedTool and ToolValidationContext.
 */
@Service
@RequiredArgsConstructor
public class SearchVulnerabilitiesTool extends PaginatedTool<VulnerabilityFilterParams, VulnLight> {

  private final VulnerabilityMapper vulnerabilityMapper;

  @Tool(
      name = "search_vulnerabilities",
      description =
          """
          Search vulnerabilities across all applications in your organization with optional filtering by
          severity, status, environment, vulnerability type, date range, and tags.

          This is an organization-level search tool. For application-scoped searches with session filtering
          capabilities, use the search_app_vulnerabilities tool instead.

          Common usage examples:
          - Critical vulnerabilities only: severities="CRITICAL"
          - High-priority open issues: severities="CRITICAL,HIGH", statuses="Reported,Confirmed"
          - Production vulnerabilities: environments="PRODUCTION"
          - Recent activity: lastSeenAfter="2025-01-01"
          - Production critical issues with recent activity: environments="PRODUCTION", severities="CRITICAL", lastSeenAfter="2025-01-01"
          - SmartFix remediated vulnerabilities: vulnTags="SmartFix Remediated", statuses="Remediated"
          - Reviewed critical vulnerabilities: vulnTags="reviewed", severities="CRITICAL"

          Note: This tool requires Contrast Platform Admin or Org Admin permissions to access organization-level
          vulnerability data.

          Returns paginated results with metadata including totalItems (when available) and hasMorePages.
          Check 'message' field for validation warnings or empty result info.

          Response fields:
          - environments: List of all environments (DEVELOPMENT, QA, PRODUCTION) where this vulnerability
                         has been seen over time. Shows historical presence across environments.
          - application: Application name and ID where the vulnerability was found.

          Related tools:
          - search_app_vulnerabilities: For app-scoped searches with session filtering
          - search_applications: To find application IDs by name, tag, or metadata
          """)
  public PaginatedToolResponse<VulnLight> searchVulnerabilities(
      @ToolParam(description = "Page number (1-based), default: 1", required = false) Integer page,
      @ToolParam(description = "Items per page (max 100), default: 50", required = false)
          Integer pageSize,
      @ToolParam(
              description =
                  "Comma-separated severities: CRITICAL,HIGH,MEDIUM,LOW,NOTE. Default: all"
                      + " severities",
              required = false)
          String severities,
      @ToolParam(
              description =
                  "Comma-separated statuses: Reported,Suspicious,Confirmed,Remediated,Fixed."
                      + " Default: Reported,Suspicious,Confirmed (excludes Fixed and Remediated to"
                      + " focus on actionable items)",
              required = false)
          String statuses,
      @ToolParam(
              description =
                  "Comma-separated vulnerability types (e.g., sql-injection,xss-reflected). Use"
                      + " list_vulnerability_types tool for complete list. Default: all types",
              required = false)
          String vulnTypes,
      @ToolParam(
              description =
                  "Comma-separated environments: DEVELOPMENT,QA,PRODUCTION. Default: all"
                      + " environments",
              required = false)
          String environments,
      @ToolParam(
              description =
                  "Only include vulnerabilities with LAST ACTIVITY after this date (ISO format:"
                      + " YYYY-MM-DD or epoch timestamp). Filters on lastTimeSeen, not discovery"
                      + " date",
              required = false)
          String lastSeenAfter,
      @ToolParam(
              description =
                  "Only include vulnerabilities with LAST ACTIVITY before this date (ISO format:"
                      + " YYYY-MM-DD or epoch timestamp). Filters on lastTimeSeen, not discovery"
                      + " date",
              required = false)
          String lastSeenBefore,
      @ToolParam(
              description =
                  "Comma-separated VULNERABILITY-LEVEL tags (e.g., 'SmartFix Remediated,reviewed')."
                      + " Note: These are vulnerability tags, not application tags. Use to find"
                      + " vulnerabilities tagged during remediation workflows",
              required = false)
          String vulnTags) {

    return executePipeline(
        page,
        pageSize,
        () ->
            VulnerabilityFilterParams.of(
                severities,
                statuses,
                vulnTypes,
                environments,
                lastSeenAfter,
                lastSeenBefore,
                vulnTags));
  }

  @Override
  protected ExecutionResult<VulnLight> doExecute(
      PaginationParams pagination, VulnerabilityFilterParams params, List<String> warnings)
      throws Exception {

    var sdkExtension = new SDKExtension(getContrastSDK());
    var filterBody = params.toTraceFilterBody();

    var traces =
        sdkExtension.getTracesInOrg(
            getOrgId(),
            filterBody,
            pagination.limit(),
            pagination.offset(),
            EnumSet.of(
                TraceExpandValue.SESSION_METADATA,
                TraceExpandValue.SERVER_ENVIRONMENTS,
                TraceExpandValue.APPLICATION));

    if (traces == null || traces.getTraces() == null) {
      warnings.add("API returned no trace data. Verify permissions and filters.");
      return ExecutionResult.empty();
    }

    var vulnerabilities =
        traces.getTraces().stream().map(vulnerabilityMapper::toVulnLight).toList();

    return ExecutionResult.of(vulnerabilities, traces.getCount());
  }
}
