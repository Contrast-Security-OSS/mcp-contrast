/*
 * Copyright 2025 Contrast Security
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.contrast.labs.ai.mcp.contrast.tool.assess;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

import com.contrast.labs.ai.mcp.contrast.config.ContrastSDKFactory;
import com.contrastsecurity.models.Rules;
import com.contrastsecurity.sdk.ContrastSDK;
import java.util.List;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.test.util.ReflectionTestUtils;

class ListVulnerabilityTypesToolTest {

  private static final String ORG_ID = "test-org-id";

  private ListVulnerabilityTypesTool tool;
  private ContrastSDKFactory sdkFactory;
  private ContrastSDK sdk;

  @BeforeEach
  void setUp() {
    sdk = mock();
    sdkFactory = mock();

    when(sdkFactory.getSDK()).thenReturn(sdk);
    when(sdkFactory.getOrgId()).thenReturn(ORG_ID);

    tool = new ListVulnerabilityTypesTool();
    ReflectionTestUtils.setField(tool, "sdkFactory", sdkFactory);
  }

  @Test
  void listVulnerabilityTypes_should_return_sorted_rule_names() throws Exception {
    var rule1 = mock(Rules.Rule.class);
    var rule2 = mock(Rules.Rule.class);
    var rule3 = mock(Rules.Rule.class);
    when(rule1.getName()).thenReturn("xss-reflected");
    when(rule2.getName()).thenReturn("sql-injection");
    when(rule3.getName()).thenReturn("cmd-injection");

    var rules = mock(Rules.class);
    when(rules.getRules()).thenReturn(List.of(rule1, rule2, rule3));
    when(sdk.getRules(eq(ORG_ID))).thenReturn(rules);

    var result = tool.listVulnerabilityTypes();

    assertThat(result.isSuccess()).isTrue();
    assertThat(result.found()).isTrue();
    assertThat(result.data()).containsExactly("cmd-injection", "sql-injection", "xss-reflected");

    verify(sdk).getRules(eq(ORG_ID));
  }

  @Test
  void listVulnerabilityTypes_should_filter_null_and_empty_names() throws Exception {
    var rule1 = mock(Rules.Rule.class);
    var rule2 = mock(Rules.Rule.class);
    var rule3 = mock(Rules.Rule.class);
    when(rule1.getName()).thenReturn("sql-injection");
    when(rule2.getName()).thenReturn(null);
    when(rule3.getName()).thenReturn("   ");

    var rules = mock(Rules.class);
    when(rules.getRules()).thenReturn(List.of(rule1, rule2, rule3));
    when(sdk.getRules(eq(ORG_ID))).thenReturn(rules);

    var result = tool.listVulnerabilityTypes();

    assertThat(result.isSuccess()).isTrue();
    assertThat(result.data()).containsExactly("sql-injection");
  }

  @Test
  void listVulnerabilityTypes_should_trim_whitespace() throws Exception {
    var rule = mock(Rules.Rule.class);
    when(rule.getName()).thenReturn("  sql-injection  ");

    var rules = mock(Rules.class);
    when(rules.getRules()).thenReturn(List.of(rule));
    when(sdk.getRules(eq(ORG_ID))).thenReturn(rules);

    var result = tool.listVulnerabilityTypes();

    assertThat(result.isSuccess()).isTrue();
    assertThat(result.data()).containsExactly("sql-injection");
  }

  @Test
  void listVulnerabilityTypes_should_add_warning_when_rules_null() throws Exception {
    when(sdk.getRules(eq(ORG_ID))).thenReturn(null);

    var result = tool.listVulnerabilityTypes();

    assertThat(result.isSuccess()).isTrue();
    assertThat(result.data()).isEmpty();
    assertThat(result.warnings()).anyMatch(w -> w.contains("No rules returned"));
  }

  @Test
  void listVulnerabilityTypes_should_add_warning_when_rules_list_null() throws Exception {
    var rules = mock(Rules.class);
    when(rules.getRules()).thenReturn(null);
    when(sdk.getRules(eq(ORG_ID))).thenReturn(rules);

    var result = tool.listVulnerabilityTypes();

    assertThat(result.isSuccess()).isTrue();
    assertThat(result.data()).isEmpty();
    assertThat(result.warnings()).anyMatch(w -> w.contains("No rules returned"));
  }

  @Test
  void listVulnerabilityTypes_should_return_empty_list_when_no_rules() throws Exception {
    var rules = mock(Rules.class);
    when(rules.getRules()).thenReturn(List.of());
    when(sdk.getRules(eq(ORG_ID))).thenReturn(rules);

    var result = tool.listVulnerabilityTypes();

    assertThat(result.isSuccess()).isTrue();
    assertThat(result.data()).isEmpty();
    assertThat(result.warnings()).isEmpty();
  }
}
